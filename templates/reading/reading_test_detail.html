<!--{% load reading_extras %}-->
<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>{{ test.title }}</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--    <style>-->
<!--        :root {-->
<!--            &#45;&#45;bg-color: #f5f7fa;-->
<!--            &#45;&#45;container-bg: white;-->
<!--            &#45;&#45;text-color: #2c3e50;-->
<!--            &#45;&#45;title-color: #2c5282;-->
<!--            &#45;&#45;border-color: #e8f4f8;-->
<!--            &#45;&#45;button-bg: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);-->
<!--            &#45;&#45;button-hover-bg: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);-->
<!--            &#45;&#45;section-bg: linear-gradient(135deg, #f8fbff 0%, #fefefe 100%);-->
<!--            &#45;&#45;question-bg: #f8f9fa;-->
<!--            &#45;&#45;input-border: #e2e8f0;-->
<!--            &#45;&#45;input-focus-border: #4299e1;-->
<!--            &#45;&#45;instructions-text: #4a5568;-->
<!--        }-->

<!--        body {-->
<!--            background-color: var(&#45;&#45;bg-color);-->
<!--            overflow: hidden;-->
<!--        }-->

<!--        .test-container {-->
<!--            display: flex;-->
<!--            height: 100vh;-->
<!--            max-width: 100%;-->
<!--            margin: 0;-->
<!--            background: var(&#45;&#45;container-bg);-->
<!--        }-->

<!--        .passage-section, .questions-section {-->
<!--            flex: 1;-->
<!--            padding: 30px;-->
<!--            overflow-y: auto;-->
<!--            background: var(&#45;&#45;section-bg);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--        }-->

<!--        .passage-section {-->
<!--            border-right: 2px solid var(&#45;&#45;border-color);-->
<!--        }-->

<!--        .passage-content-area {-->
<!--            flex-grow: 1;-->
<!--            overflow-y: auto;-->
<!--            margin-bottom: 1rem;-->
<!--        }-->

<!--        .passage-title {-->
<!--            color: var(&#45;&#45;title-color);-->
<!--            font-size: 28px;-->
<!--            font-weight: 700;-->
<!--            margin-bottom: 25px;-->
<!--            text-align: center;-->
<!--            border-bottom: 3px solid var(&#45;&#45;input-focus-border);-->
<!--            padding-bottom: 10px;-->
<!--        }-->

<!--        .passage-content p {-->
<!--            margin-bottom: 18px;-->
<!--            text-indent: 20px;-->
<!--            text-align: justify;-->
<!--            line-height: 1.8;-->
<!--        }-->

<!--        .questions-title {-->
<!--            color: var(&#45;&#45;text-color);-->
<!--            font-size: 24px;-->
<!--            font-weight: 700;-->
<!--            margin-bottom: 20px;-->
<!--            text-align: center;-->
<!--            background: var(&#45;&#45;question-bg);-->
<!--            padding: 15px;-->
<!--            border-radius: 8px;-->
<!--            border-left: 4px solid var(&#45;&#45;input-focus-border);-->
<!--        }-->

<!--        .question-block {-->
<!--            margin-bottom: 30px;-->
<!--            background: var(&#45;&#45;question-bg);-->
<!--            padding: 20px;-->
<!--            border-radius: 10px;-->
<!--            border-left: 4px solid #38a169;-->
<!--        }-->

<!--        .question-instructions {-->
<!--            margin-bottom: 15px;-->
<!--            font-style: italic;-->
<!--            color: var(&#45;&#45;instructions-text);-->
<!--        }-->

<!--        .submit-btn {-->
<!--            width: 100%;-->
<!--            padding: 15px;-->
<!--            background: var(&#45;&#45;button-bg);-->
<!--            color: white;-->
<!--            border: none;-->
<!--            border-radius: 8px;-->
<!--            font-size: 16px;-->
<!--            font-weight: 600;-->
<!--            cursor: pointer;-->
<!--            transition: all 0.3s;-->
<!--            margin-top: 20px;-->
<!--        }-->

<!--        .submit-btn:hover {-->
<!--            background: var(&#45;&#45;button-hover-bg);-->
<!--            transform: translateY(-2px);-->
<!--        }-->

<!--        .form-control, .form-select {-->
<!--            border-color: var(&#45;&#45;input-border);-->
<!--        }-->
<!--        .form-control:focus, .form-select:focus {-->
<!--            border-color: var(&#45;&#45;input-focus-border);-->
<!--            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);-->
<!--        }-->

<!--        .timer {-->
<!--            position: fixed;-->
<!--            top: 15px;-->
<!--            right: 25px;-->
<!--            background: white;-->
<!--            padding: 8px 15px;-->
<!--            border-radius: 20px;-->
<!--            font-size: 16px;-->
<!--            font-weight: 700;-->
<!--            color: #e53e3e;-->
<!--            box-shadow: 0 2px 10px rgba(0,0,0,0.1);-->
<!--            z-index: 1000;-->
<!--            transition: color 0.3s, background-color 0.3s, box-shadow 0.3s;-->
<!--        }-->

<!--        .timer.cheating {-->
<!--            color: #fff;-->
<!--            background-color: #e53e3e;-->
<!--            box-shadow: 0 0 15px #e53e3e;-->
<!--        }-->

<!--        .user-highlight {-->
<!--            background-color: #fff799;-->
<!--            padding: 0.1em 0;-->
<!--            border-radius: 3px;-->
<!--        }-->

<!--        #highlighter-menu {-->
<!--            position: absolute;-->
<!--            display: none;-->
<!--            background-color: #333;-->
<!--            border-radius: 8px;-->
<!--            padding: 5px;-->
<!--            z-index: 1001;-->
<!--            box-shadow: 0 4px 8px rgba(0,0,0,0.2);-->
<!--        }-->

<!--        #highlighter-menu button {-->
<!--            background: none;-->
<!--            border: none;-->
<!--            color: white;-->
<!--            padding: 8px 12px;-->
<!--            cursor: pointer;-->
<!--            font-size: 18px;-->
<!--        }-->

<!--        #highlighter-menu button:hover {-->
<!--            background-color: #555;-->
<!--            border-radius: 5px;-->
<!--        }-->

<!--        #blocked-overlay {-->
<!--            position: fixed;-->
<!--            top: 0;-->
<!--            left: 0;-->
<!--            width: 100%;-->
<!--            height: 100%;-->
<!--            background-color: rgba(0, 0, 0, 0.85);-->
<!--            z-index: 9999;-->
<!--            display: none;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--            text-align: center;-->
<!--            color: white;-->
<!--        }-->

<!--        @media (max-width: 768px) {-->
<!--            .test-container {-->
<!--                flex-direction: column;-->
<!--                height: auto;-->
<!--            }-->
<!--            .passage-section {-->
<!--                border-right: none;-->
<!--                border-bottom: 2px solid var(&#45;&#45;border-color);-->
<!--                max-height: 50vh;-->
<!--            }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->

<!--    <div id="timer" class="timer">$60:00$</div>-->

<!--    <form id="ielts-test-form" method="POST" action="{% url 'submit_reading_test' test.id %}">-->
<!--        {% csrf_token %}-->
<!--        <div class="test-container">-->
<!--            &lt;!&ndash; LEFT COLUMN: PASSAGES &ndash;&gt;-->
<!--            <div class="passage-section">-->
<!--                <h1 class="passage-title">{{ test.title }}</h1>-->
<!--                <div class="tab-content passage-content-area">-->
<!--                    <div class="tab-pane fade show active" id="p1" role="tabpanel">{{ test.passage_1|format_text|linebreaksbr }}</div>-->
<!--                    <div class="tab-pane fade" id="p2" role="tabpanel">{{ test.passage_2|format_text|linebreaksbr }}</div>-->
<!--                    <div class="tab-pane fade" id="p3" role="tabpanel">{{ test.passage_3|format_text|linebreaksbr }}</div>-->
<!--                </div>-->
<!--                <ul class="nav nav-tabs mt-auto" id="passageTabs" role="tablist">-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#p1" type="button">Passage 1</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p2" type="button">Passage 2</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p3" type="button">Passage 3</button></li>-->
<!--                </ul>-->
<!--            </div>-->

<!--            &lt;!&ndash; RIGHT COLUMN: QUESTIONS &ndash;&gt;-->
<!--            <div class="questions-section">-->
<!--                <h2 class="questions-title">Questions</h2>-->
<!--                <ul class="nav nav-tabs mb-3" id="questionTabs" role="tablist">-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#q1" type="button">Passage 1 Questions</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q2" type="button">Passage 2 Questions</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q3" type="button">Passage 3 Questions</button></li>-->
<!--                </ul>-->
<!--                <div class="tab-content">-->
<!--                    <div class="tab-pane fade show active" id="q1" role="tabpanel">-->
<!--                        {% for block in passage_1_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                    <div class="tab-pane fade" id="q2" role="tabpanel">-->
<!--                        {% for block in passage_2_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                    <div class="tab-pane fade" id="q3" role="tabpanel">-->
<!--                        {% for block in passage_3_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                </div>-->
<!--                <button type="submit" class="submit-btn">Submit Test</button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </form>-->

<!--    <div id="highlighter-menu">-->
<!--        <button id="highlight-btn">‚úèÔ∏è Highlight</button>-->
<!--        <button id="delete-highlight-btn">üóëÔ∏è Remove</button>-->
<!--    </div>-->

<!--    <div id="blocked-overlay">-->
<!--        <div>-->
<!--            <h1 class="display-4">Test Blocked</h1>-->
<!--            <p class="lead">You have switched tabs too many times.</p>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        const timerElement = document.getElementById('timer');-->
<!--        const testForm = document.getElementById('ielts-test-form');-->
<!--        const blockedOverlay = document.getElementById('blocked-overlay');-->

<!--        // -&#45;&#45; TIMER SCRIPT WITH ANTI-CHEAT (REWRITTEN) -&#45;&#45;-->
<!--        let switchCount = 0;-->
<!--        const switchLimit = 3;-->

<!--        const examTimer = {-->
<!--            timeLeft: 3600,-->
<!--            speed: 1000,-->
<!--            intervalId: null,-->

<!--            tick: function() {-->
<!--                if (this.timeLeft <= 0) {-->
<!--                    this.stop();-->
<!--                    alert("Time's up!");-->
<!--                    testForm.submit();-->
<!--                    return;-->
<!--                }-->

<!--                this.timeLeft&#45;&#45;;-->
<!--                const minutes = Math.floor(this.timeLeft / 60);-->
<!--                const seconds = this.timeLeft % 60;-->
<!--                timerElement.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;-->
<!--            },-->

<!--            start: function() {-->
<!--                if (this.intervalId) this.stop();-->
<!--                this.intervalId = setInterval(this.tick.bind(this), this.speed);-->
<!--            },-->

<!--            stop: function() {-->
<!--                clearInterval(this.intervalId);-->
<!--                this.intervalId = null;-->
<!--            },-->

<!--            setSpeed: function(newSpeed) {-->
<!--                this.speed = newSpeed;-->
<!--                this.stop();-->
<!--                this.start();-->
<!--            }-->
<!--        };-->

<!--        function blockTest() {-->
<!--            examTimer.stop();-->
<!--            timerElement.textContent = "Blocked";-->
<!--            timerElement.classList.add('cheating');-->
<!--            blockedOverlay.style.display = 'flex';-->

<!--            // Disable all form elements-->
<!--            const formElements = testForm.querySelectorAll('input, select, button');-->
<!--            formElements.forEach(el => el.disabled = true);-->

<!--            // Remove the listener so it doesn't trigger again-->
<!--            document.removeEventListener('visibilitychange', handleVisibilityChange);-->
<!--        }-->

<!--        function handleVisibilityChange() {-->
<!--            if (document.hidden) {-->
<!--                switchCount++;-->
<!--                if (switchCount > switchLimit) {-->
<!--                    blockTest();-->
<!--                } else {-->
<!--                    timerElement.classList.add('cheating');-->
<!--                    examTimer.setSpeed(500); // 2x speed-->
<!--                }-->
<!--            } else {-->
<!--                timerElement.classList.remove('cheating');-->
<!--                examTimer.setSpeed(1000); // Return to 1x speed-->
<!--            }-->
<!--        }-->

<!--        document.addEventListener('visibilitychange', handleVisibilityChange);-->
<!--        examTimer.start();-->

<!--        // -&#45;&#45; SYNCHRONIZED TABS SCRIPT -&#45;&#45;-->
<!--        const passageTabs = document.querySelectorAll('#passageTabs .nav-link');-->
<!--        passageTabs.forEach(tab => {-->
<!--            tab.addEventListener('click', function (event) {-->
<!--                const passageTargetId = this.getAttribute('data-bs-target');-->
<!--                const questionTargetId = passageTargetId.replace('#p', '#q');-->
<!--                const questionTab = document.querySelector(`#questionTabs [data-bs-target="${questionTargetId}"]`);-->
<!--                if (questionTab) {-->
<!--                    new bootstrap.Tab(questionTab).show();-->
<!--                }-->
<!--            });-->
<!--        });-->

<!--        // -&#45;&#45; ADVANCED HIGHLIGHTER SCRIPT -&#45;&#45;-->
<!--        const menu = document.getElementById('highlighter-menu');-->
<!--        const highlightBtn = document.getElementById('highlight-btn');-->
<!--        const deleteBtn = document.getElementById('delete-highlight-btn');-->
<!--        const highlightableAreas = document.querySelectorAll('.passage-section, .questions-section');-->

<!--        let savedRange;-->
<!--        let targetMark;-->

<!--        function onMouseUp(event) {-->
<!--            setTimeout(() => {-->
<!--                const selection = window.getSelection();-->
<!--                const selectedText = selection.toString().trim();-->

<!--                let ancestorMark = null;-->
<!--                if (!selection.isCollapsed) {-->
<!--                    const range = selection.getRangeAt(0);-->
<!--                    const commonAncestor = range.commonAncestorContainer;-->
<!--                    ancestorMark = commonAncestor.nodeType === Node.ELEMENT_NODE-->
<!--                        ? commonAncestor.closest('mark.user-highlight')-->
<!--                        : commonAncestor.parentElement.closest('mark.user-highlight');-->
<!--                }-->

<!--                const clickedMark = event.target.closest('mark.user-highlight');-->

<!--                if (ancestorMark || (clickedMark && selectedText.length === 0)) {-->
<!--                    targetMark = ancestorMark || clickedMark;-->
<!--                    highlightBtn.style.display = 'none';-->
<!--                    deleteBtn.style.display = 'block';-->
<!--                    const rect = targetMark.getBoundingClientRect();-->
<!--                    menu.style.left = `${rect.left + window.scrollX}px`;-->
<!--                    menu.style.top = `${rect.top + window.scrollY - 40}px`;-->
<!--                    menu.style.display = 'block';-->
<!--                } else if (selectedText.length > 0) {-->
<!--                    savedRange = selection.getRangeAt(0);-->
<!--                    const rect = savedRange.getBoundingClientRect();-->
<!--                    highlightBtn.style.display = 'block';-->
<!--                    deleteBtn.style.display = 'none';-->
<!--                    menu.style.left = `${rect.right + window.scrollX + 5}px`;-->
<!--                    menu.style.top = `${rect.top + window.scrollY}px`;-->
<!--                    menu.style.display = 'block';-->
<!--                } else {-->
<!--                    menu.style.display = 'none';-->
<!--                }-->
<!--            }, 10);-->
<!--        }-->

<!--        highlightableAreas.forEach(area => area.addEventListener('mouseup', onMouseUp));-->

<!--        highlightBtn.addEventListener('click', function(e) {-->
<!--            e.preventDefault();-->
<!--            e.stopPropagation();-->
<!--            if (savedRange) {-->
<!--                const mark = document.createElement('mark');-->
<!--                mark.className = 'user-highlight';-->
<!--                try {-->
<!--                    savedRange.surroundContents(mark);-->
<!--                    savedRange = null;-->
<!--                } catch (err) { console.error("Highlighting failed:", err); }-->
<!--            }-->
<!--            menu.style.display = 'none';-->
<!--            window.getSelection().removeAllRanges();-->
<!--        });-->

<!--        deleteBtn.addEventListener('click', function(e) {-->
<!--            e.preventDefault();-->
<!--            e.stopPropagation();-->
<!--            if (targetMark) {-->
<!--                const parent = targetMark.parentNode;-->
<!--                while (targetMark.firstChild) {-->
<!--                    parent.insertBefore(targetMark.firstChild, targetMark);-->
<!--                }-->
<!--                parent.removeChild(targetMark);-->
<!--                targetMark = null;-->
<!--            }-->
<!--            menu.style.display = 'none';-->
<!--        });-->

<!--        window.addEventListener('click', function(e) {-->
<!--            if (!menu.contains(e.target)) {-->
<!--                menu.style.display = 'none';-->
<!--            }-->
<!--        });-->
<!--    });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->
<!--{% load reading_extras %}-->
<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>{{ test.title }}</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--    <style>-->
<!--        :root {-->
<!--            &#45;&#45;bg-color: #f5f7fa;-->
<!--            &#45;&#45;container-bg: white;-->
<!--            &#45;&#45;text-color: #2c3e50;-->
<!--            &#45;&#45;title-color: #2c5282;-->
<!--            &#45;&#45;border-color: #e8f4f8;-->
<!--            &#45;&#45;button-bg: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);-->
<!--            &#45;&#45;button-hover-bg: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);-->
<!--            &#45;&#45;section-bg: linear-gradient(135deg, #f8fbff 0%, #fefefe 100%);-->
<!--            &#45;&#45;question-bg: #f8f9fa;-->
<!--            &#45;&#45;input-border: #e2e8f0;-->
<!--            &#45;&#45;input-focus-border: #4299e1;-->
<!--            &#45;&#45;instructions-text: #4a5568;-->
<!--        }-->

<!--        body {-->
<!--            background-color: var(&#45;&#45;bg-color);-->
<!--            overflow: hidden;-->
<!--        }-->

<!--        .test-container {-->
<!--            display: flex;-->
<!--            height: 100vh;-->
<!--            max-width: 100%;-->
<!--            margin: 0;-->
<!--            background: var(&#45;&#45;container-bg);-->
<!--        }-->

<!--        .passage-section, .questions-section {-->
<!--            flex: 1;-->
<!--            padding: 30px;-->
<!--            overflow-y: auto;-->
<!--            background: var(&#45;&#45;section-bg);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--        }-->

<!--        .passage-section {-->
<!--            border-right: 2px solid var(&#45;&#45;border-color);-->
<!--        }-->

<!--        .passage-content-area {-->
<!--            flex-grow: 1;-->
<!--            overflow-y: auto;-->
<!--            margin-bottom: 1rem;-->
<!--        }-->

<!--        .passage-title {-->
<!--            color: var(&#45;&#45;title-color);-->
<!--            font-size: 28px;-->
<!--            font-weight: 700;-->
<!--            margin-bottom: 25px;-->
<!--            text-align: center;-->
<!--            border-bottom: 3px solid var(&#45;&#45;input-focus-border);-->
<!--            padding-bottom: 10px;-->
<!--        }-->

<!--        .passage-content p {-->
<!--            margin-bottom: 18px;-->
<!--            text-indent: 20px;-->
<!--            text-align: justify;-->
<!--            line-height: 1.8;-->
<!--        }-->

<!--        .questions-title {-->
<!--            color: var(&#45;&#45;text-color);-->
<!--            font-size: 24px;-->
<!--            font-weight: 700;-->
<!--            margin-bottom: 20px;-->
<!--            text-align: center;-->
<!--            background: var(&#45;&#45;question-bg);-->
<!--            padding: 15px;-->
<!--            border-radius: 8px;-->
<!--            border-left: 4px solid var(&#45;&#45;input-focus-border);-->
<!--        }-->

<!--        .question-block {-->
<!--            margin-bottom: 30px;-->
<!--            background: var(&#45;&#45;question-bg);-->
<!--            padding: 20px;-->
<!--            border-radius: 10px;-->
<!--            border-left: 4px solid #38a169;-->
<!--        }-->

<!--        .question-instructions {-->
<!--            margin-bottom: 15px;-->
<!--            font-style: italic;-->
<!--            color: var(&#45;&#45;instructions-text);-->
<!--        }-->

<!--        .submit-btn {-->
<!--            width: 100%;-->
<!--            padding: 15px;-->
<!--            background: var(&#45;&#45;button-bg);-->
<!--            color: white;-->
<!--            border: none;-->
<!--            border-radius: 8px;-->
<!--            font-size: 16px;-->
<!--            font-weight: 600;-->
<!--            cursor: pointer;-->
<!--            transition: all 0.3s;-->
<!--            margin-top: 20px;-->
<!--        }-->

<!--        .submit-btn:hover {-->
<!--            background: var(&#45;&#45;button-hover-bg);-->
<!--            transform: translateY(-2px);-->
<!--        }-->

<!--        .form-control, .form-select {-->
<!--            border-color: var(&#45;&#45;input-border);-->
<!--        }-->
<!--        .form-control:focus, .form-select:focus {-->
<!--            border-color: var(&#45;&#45;input-focus-border);-->
<!--            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);-->
<!--        }-->

<!--        .timer {-->
<!--            position: fixed;-->
<!--            top: 15px;-->
<!--            right: 25px;-->
<!--            background: white;-->
<!--            padding: 8px 15px;-->
<!--            border-radius: 20px;-->
<!--            font-size: 16px;-->
<!--            font-weight: 700;-->
<!--            color: #e53e3e;-->
<!--            box-shadow: 0 2px 10px rgba(0,0,0,0.1);-->
<!--            z-index: 1000;-->
<!--            transition: color 0.3s, background-color 0.3s, box-shadow 0.3s;-->
<!--        }-->

<!--        .timer.cheating {-->
<!--            color: #fff;-->
<!--            background-color: #e53e3e;-->
<!--            box-shadow: 0 0 15px #e53e3e;-->
<!--        }-->

<!--        .user-highlight {-->
<!--            background-color: #fff799;-->
<!--            padding: 0.1em 0;-->
<!--            border-radius: 3px;-->
<!--        }-->

<!--        #highlighter-menu {-->
<!--            position: absolute;-->
<!--            display: none;-->
<!--            background-color: #333;-->
<!--            border-radius: 8px;-->
<!--            padding: 5px;-->
<!--            z-index: 1001;-->
<!--            box-shadow: 0 4px 8px rgba(0,0,0,0.2);-->
<!--        }-->

<!--        #highlighter-menu button {-->
<!--            background: none;-->
<!--            border: none;-->
<!--            color: white;-->
<!--            padding: 8px 12px;-->
<!--            cursor: pointer;-->
<!--            font-size: 18px;-->
<!--        }-->

<!--        #highlighter-menu button:hover {-->
<!--            background-color: #555;-->
<!--            border-radius: 5px;-->
<!--        }-->

<!--        #blocked-overlay {-->
<!--            position: fixed;-->
<!--            top: 0;-->
<!--            left: 0;-->
<!--            width: 100%;-->
<!--            height: 100%;-->
<!--            background-color: rgba(0, 0, 0, 0.85);-->
<!--            z-index: 9999;-->
<!--            display: none;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--            text-align: center;-->
<!--            color: white;-->
<!--        }-->

<!--        @media (max-width: 768px) {-->
<!--            .test-container {-->
<!--                flex-direction: column;-->
<!--                height: auto;-->
<!--            }-->
<!--            .passage-section {-->
<!--                border-right: none;-->
<!--                border-bottom: 2px solid var(&#45;&#45;border-color);-->
<!--                max-height: 50vh;-->
<!--            }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->

<!--    <div id="timer" class="timer">$60:00$</div>-->

<!--    <form id="ielts-test-form" method="POST" action="{% url 'submit_reading_test' test.id %}">-->
<!--        {% csrf_token %}-->
<!--        <div class="test-container">-->
<!--            &lt;!&ndash; LEFT COLUMN: PASSAGES &ndash;&gt;-->
<!--            <div class="passage-section">-->
<!--                <h1 class="passage-title">{{ test.title }}</h1>-->
<!--                <div class="tab-content passage-content-area">-->
<!--                    <div class="tab-pane fade show active" id="p1" role="tabpanel">{{ test.passage_1|format_text|linebreaksbr }}</div>-->
<!--                    <div class="tab-pane fade" id="p2" role="tabpanel">{{ test.passage_2|format_text|linebreaksbr }}</div>-->
<!--                    <div class="tab-pane fade" id="p3" role="tabpanel">{{ test.passage_3|format_text|linebreaksbr }}</div>-->
<!--                </div>-->
<!--                <ul class="nav nav-tabs mt-auto" id="passageTabs" role="tablist">-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#p1" type="button">Passage 1</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p2" type="button">Passage 2</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p3" type="button">Passage 3</button></li>-->
<!--                </ul>-->
<!--            </div>-->

<!--            &lt;!&ndash; RIGHT COLUMN: QUESTIONS &ndash;&gt;-->
<!--            <div class="questions-section">-->
<!--                <h2 class="questions-title">Questions</h2>-->
<!--                <ul class="nav nav-tabs mb-3" id="questionTabs" role="tablist">-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#q1" type="button">Passage 1 Questions</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q2" type="button">Passage 2 Questions</button></li>-->
<!--                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q3" type="button">Passage 3 Questions</button></li>-->
<!--                </ul>-->
<!--                <div class="tab-content">-->
<!--                    <div class="tab-pane fade show active" id="q1" role="tabpanel">-->
<!--                        {% for block in passage_1_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                    <div class="tab-pane fade" id="q2" role="tabpanel">-->
<!--                        {% for block in passage_2_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                    <div class="tab-pane fade" id="q3" role="tabpanel">-->
<!--                        {% for block in passage_3_blocks %}{% include 'reading/question_block.html' %}{% endfor %}-->
<!--                    </div>-->
<!--                </div>-->
<!--                <button type="submit" class="submit-btn">Submit Test</button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </form>-->

<!--    <div id="highlighter-menu">-->
<!--        <button id="highlight-btn">‚úèÔ∏è Highlight</button>-->
<!--        <button id="delete-highlight-btn">üóëÔ∏è Remove</button>-->
<!--    </div>-->

<!--    <div id="blocked-overlay">-->
<!--        <div>-->
<!--            <h1 class="display-4">Test Blocked</h1>-->
<!--            <p class="lead">You have switched tabs too many times.</p>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        const timerElement = document.getElementById('timer');-->
<!--        const testForm = document.getElementById('ielts-test-form');-->
<!--        const blockedOverlay = document.getElementById('blocked-overlay');-->

<!--        // -&#45;&#45; TIMER SCRIPT WITH ANTI-CHEAT (REWRITTEN) -&#45;&#45;-->
<!--        let switchCount = 0;-->
<!--        const switchLimit = 3;-->

<!--        const examTimer = {-->
<!--            timeLeft: 3600,-->
<!--            speed: 1000,-->
<!--            intervalId: null,-->

<!--            tick: function() {-->
<!--                if (this.timeLeft <= 0) {-->
<!--                    this.stop();-->
<!--                    alert("Time's up!");-->
<!--                    testForm.submit();-->
<!--                    return;-->
<!--                }-->

<!--                this.timeLeft&#45;&#45;;-->
<!--                const minutes = Math.floor(this.timeLeft / 60);-->
<!--                const seconds = this.timeLeft % 60;-->
<!--                timerElement.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;-->
<!--            },-->

<!--            start: function() {-->
<!--                if (this.intervalId) this.stop();-->
<!--                this.intervalId = setInterval(this.tick.bind(this), this.speed);-->
<!--            },-->

<!--            stop: function() {-->
<!--                clearInterval(this.intervalId);-->
<!--                this.intervalId = null;-->
<!--            },-->

<!--            setSpeed: function(newSpeed) {-->
<!--                if (this.speed !== newSpeed) {-->
<!--                    this.speed = newSpeed;-->
<!--                    this.stop();-->
<!--                    this.start();-->
<!--                }-->
<!--            }-->
<!--        };-->

<!--        function blockTest() {-->
<!--            examTimer.stop();-->
<!--            timerElement.textContent = "Blocked";-->
<!--            timerElement.classList.add('cheating');-->
<!--            blockedOverlay.style.display = 'flex';-->

<!--            const formElements = testForm.querySelectorAll('input, select, button');-->
<!--            formElements.forEach(el => el.disabled = true);-->
<!--            document.removeEventListener('visibilitychange', handleVisibilityChange);-->
<!--        }-->

<!--        function handleVisibilityChange() {-->
<!--            if (document.hidden) {-->
<!--                switchCount++;-->
<!--                if (switchCount > switchLimit) {-->
<!--                    blockTest();-->
<!--                } else {-->
<!--                    timerElement.classList.add('cheating');-->
<!--                    examTimer.setSpeed(500); // 2x speed-->
<!--                }-->
<!--            } else {-->
<!--                timerElement.classList.remove('cheating');-->
<!--                examTimer.setSpeed(1000); // Return to 1x speed-->
<!--            }-->
<!--        }-->

<!--        // This prevents the timer from starting at 2x on reload-->
<!--        if (document.visibilityState === 'hidden') {-->
<!--            handleVisibilityChange();-->
<!--        } else {-->
<!--            examTimer.start();-->
<!--        }-->
<!--        document.addEventListener('visibilitychange', handleVisibilityChange);-->


<!--        // -&#45;&#45; SYNCHRONIZED TABS SCRIPT -&#45;&#45;-->
<!--        const passageTabs = document.querySelectorAll('#passageTabs .nav-link');-->
<!--        passageTabs.forEach(tab => {-->
<!--            tab.addEventListener('click', function (event) {-->
<!--                const passageTargetId = this.getAttribute('data-bs-target');-->
<!--                const questionTargetId = passageTargetId.replace('#p', '#q');-->
<!--                const questionTab = document.querySelector(`#questionTabs [data-bs-target="${questionTargetId}"]`);-->
<!--                if (questionTab) {-->
<!--                    new bootstrap.Tab(questionTab).show();-->
<!--                }-->
<!--            });-->
<!--        });-->

<!--        // -&#45;&#45; ADVANCED HIGHLIGHTER SCRIPT -&#45;&#45;-->
<!--        const menu = document.getElementById('highlighter-menu');-->
<!--        const highlightBtn = document.getElementById('highlight-btn');-->
<!--        const deleteBtn = document.getElementById('delete-highlight-btn');-->
<!--        const highlightableAreas = document.querySelectorAll('.passage-section, .questions-section');-->

<!--        let savedRange;-->
<!--        let targetMark;-->

<!--        function onMouseUp(event) {-->
<!--            setTimeout(() => {-->
<!--                const selection = window.getSelection();-->
<!--                const selectedText = selection.toString().trim();-->

<!--                let ancestorMark = null;-->
<!--                if (!selection.isCollapsed) {-->
<!--                    const range = selection.getRangeAt(0);-->
<!--                    const commonAncestor = range.commonAncestorContainer;-->
<!--                    ancestorMark = commonAncestor.nodeType === Node.ELEMENT_NODE-->
<!--                        ? commonAncestor.closest('mark.user-highlight')-->
<!--                        : commonAncestor.parentElement.closest('mark.user-highlight');-->
<!--                }-->

<!--                const clickedMark = event.target.closest('mark.user-highlight');-->

<!--                if (ancestorMark || (clickedMark && selectedText.length === 0)) {-->
<!--                    targetMark = ancestorMark || clickedMark;-->
<!--                    highlightBtn.style.display = 'none';-->
<!--                    deleteBtn.style.display = 'block';-->
<!--                    const rect = targetMark.getBoundingClientRect();-->
<!--                    menu.style.left = `${rect.left + window.scrollX}px`;-->
<!--                    menu.style.top = `${rect.top + window.scrollY - 40}px`;-->
<!--                    menu.style.display = 'block';-->
<!--                } else if (selectedText.length > 0) {-->
<!--                    savedRange = selection.getRangeAt(0);-->
<!--                    const rect = savedRange.getBoundingClientRect();-->
<!--                    highlightBtn.style.display = 'block';-->
<!--                    deleteBtn.style.display = 'none';-->
<!--                    menu.style.left = `${rect.right + window.scrollX + 5}px`;-->
<!--                    menu.style.top = `${rect.top + window.scrollY}px`;-->
<!--                    menu.style.display = 'block';-->
<!--                } else {-->
<!--                    menu.style.display = 'none';-->
<!--                }-->
<!--            }, 10);-->
<!--        }-->

<!--        highlightableAreas.forEach(area => area.addEventListener('mouseup', onMouseUp));-->

<!--        highlightBtn.addEventListener('click', function(e) {-->
<!--            e.preventDefault();-->
<!--            e.stopPropagation();-->
<!--            if (savedRange) {-->
<!--                const mark = document.createElement('mark');-->
<!--                mark.className = 'user-highlight';-->
<!--                try {-->
<!--                    savedRange.surroundContents(mark);-->
<!--                    savedRange = null;-->
<!--                } catch (err) { console.error("Highlighting failed:", err); }-->
<!--            }-->
<!--            menu.style.display = 'none';-->
<!--            window.getSelection().removeAllRanges();-->
<!--        });-->

<!--        deleteBtn.addEventListener('click', function(e) {-->
<!--            e.preventDefault();-->
<!--            e.stopPropagation();-->
<!--            if (targetMark) {-->
<!--                const parent = targetMark.parentNode;-->
<!--                while (targetMark.firstChild) {-->
<!--                    parent.insertBefore(targetMark.firstChild, targetMark);-->
<!--                }-->
<!--                parent.removeChild(targetMark);-->
<!--                targetMark = null;-->
<!--            }-->
<!--            menu.style.display = 'none';-->
<!--        });-->

<!--        window.addEventListener('click', function(e) {-->
<!--            if (!menu.contains(e.target)) {-->
<!--                menu.style.display = 'none';-->
<!--            }-->
<!--        });-->
<!--    });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->
{% load reading_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ test.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --container-bg: white;
            --text-color: #2c3e50;
            --title-color: #2c5282;
            --border-color: #e8f4f8;
            --button-bg: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            --button-hover-bg: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
            --section-bg: linear-gradient(135deg, #f8fbff 0%, #fefefe 100%);
            --question-bg: #f8f9fa;
            --input-border: #e2e8f0;
            --input-focus-border: #4299e1;
            --instructions-text: #4a5568;
        }

        body {
            background-color: var(--bg-color);
            overflow: hidden;
        }

        .test-container {
            display: flex;
            height: 100vh;
            max-width: 100%;
            margin: 0;
            background: var(--container-bg);
        }

        .passage-section, .questions-section {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--section-bg);
            display: flex;
            flex-direction: column;
        }

        .passage-section {
            border-right: 2px solid var(--border-color);
        }

        .passage-content-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .passage-title {
            color: var(--title-color);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 3px solid var(--input-focus-border);
            padding-bottom: 10px;
        }

        .passage-content p {
            margin-bottom: 18px;
            text-indent: 20px;
            text-align: justify;
            line-height: 1.8;
        }

        .questions-title {
            color: var(--text-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            background: var(--question-bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--input-focus-border);
        }

        .question-block {
            margin-bottom: 30px;
            background: var(--question-bg);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #38a169;
        }

        .question-instructions {
            margin-bottom: 15px;
            font-style: italic;
            color: var(--instructions-text);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: var(--button-hover-bg);
            transform: translateY(-2px);
        }

        .form-control, .form-select {
            border-color: var(--input-border);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .timer {
            position: fixed;
            top: 15px;
            right: 25px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
            color: #e53e3e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: color 0.3s, background-color 0.3s, box-shadow 0.3s;
        }

        .timer.cheating {
            color: #fff;
            background-color: #e53e3e;
            box-shadow: 0 0 15px #e53e3e;
        }

        .user-highlight {
            background-color: #fff799;
            padding: 0.1em 0;
            border-radius: 3px;
        }

        #highlighter-menu {
            position: absolute;
            display: none;
            background-color: #333;
            border-radius: 8px;
            padding: 5px;
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #highlighter-menu button {
            background: none;
            border: none;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
        }

        #highlighter-menu button:hover {
            background-color: #555;
            border-radius: 5px;
        }

        #blocked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
        }

        @media (max-width: 768px) {
            .test-container {
                flex-direction: column;
                height: auto;
            }
            .passage-section {
                border-right: none;
                border-bottom: 2px solid var(--border-color);
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>

    <div id="timer" class="timer">$60:00$</div>

    <form id="ielts-test-form" method="POST" action="{% url 'submit_reading_test' test.id %}">
        {% csrf_token %}
        <div class="test-container">
            <!-- LEFT COLUMN: PASSAGES -->
            <div class="passage-section">
                <h1 class="passage-title">{{ test.title }}</h1>
                <div class="tab-content passage-content-area">
                    <div class="tab-pane fade show active" id="p1" role="tabpanel">{{ test.passage_1|format_text|linebreaksbr }}</div>
                    <div class="tab-pane fade" id="p2" role="tabpanel">{{ test.passage_2|format_text|linebreaksbr }}</div>
                    <div class="tab-pane fade" id="p3" role="tabpanel">{{ test.passage_3|format_text|linebreaksbr }}</div>
                </div>
                <ul class="nav nav-tabs mt-auto" id="passageTabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#p1" type="button">Passage 1</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p2" type="button">Passage 2</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p3" type="button">Passage 3</button></li>
                </ul>
            </div>

            <!-- RIGHT COLUMN: QUESTIONS -->
            <div class="questions-section">
                <h2 class="questions-title">Questions</h2>
                <ul class="nav nav-tabs mb-3" id="questionTabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#q1" type="button">Passage 1 Questions</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q2" type="button">Passage 2 Questions</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#q3" type="button">Passage 3 Questions</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="q1" role="tabpanel">
                        {% for block in passage_1_blocks %}{% include 'reading/question_block.html' %}{% endfor %}
                    </div>
                    <div class="tab-pane fade" id="q2" role="tabpanel">
                        {% for block in passage_2_blocks %}{% include 'reading/question_block.html' %}{% endfor %}
                    </div>
                    <div class="tab-pane fade" id="q3" role="tabpanel">
                        {% for block in passage_3_blocks %}{% include 'reading/question_block.html' %}{% endfor %}
                    </div>
                </div>
                <button type="submit" class="submit-btn">Submit Test</button>
            </div>
        </div>
    </form>

    <div id="highlighter-menu">
        <button id="highlight-btn">‚úèÔ∏è Highlight</button>
        <button id="delete-highlight-btn">üóëÔ∏è Remove</button>
    </div>

    <div id="blocked-overlay">
        <div>
            <h1 class="display-4">Test Blocked</h1>
            <p class="lead">You have switched tabs too many times.</p>
        </div>
    </div>

    <!-- Hidden audio players for alerts -->
    <audio id="warning-sound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
    <audio id="blocked-sound" src="https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3" preload="auto"></audio>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const timerElement = document.getElementById('timer');
        const testForm = document.getElementById('ielts-test-form');
        const blockedOverlay = document.getElementById('blocked-overlay');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const warningSound = document.getElementById('warning-sound');
        const blockedSound = document.getElementById('blocked-sound');

        // --- TIMER SCRIPT WITH ANTI-CHEAT ---
        let switchCount = 0;
        const switchLimit = 3;

        const examTimer = {
            timeLeft: 3600,
            intervalId: null,

            tick: function() {
                if (this.timeLeft <= 0) {
                    this.stop();
                    alert("Time's up!");
                    testForm.submit();
                    return;
                }

                this.timeLeft--;
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                timerElement.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            },

            start: function() {
                if (this.intervalId) this.stop();
                this.intervalId = setInterval(this.tick.bind(this), 1000);
            },

            stop: function() {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
        };

        function blockTest() {
            examTimer.stop();
            timerElement.textContent = "Blocked";
            timerElement.classList.add('cheating');
            blockedOverlay.style.display = 'flex';
            blockedSound.play();

            const formElements = testForm.querySelectorAll('input, select, button');
            formElements.forEach(el => el.disabled = true);
            document.removeEventListener('visibilitychange', handleVisibilityChange);

            fetch("{% url 'block_user' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                switchCount++;
                warningSound.play();
                timerElement.classList.add('cheating');
                if (switchCount > switchLimit) {
                    blockTest();
                }
            } else {
                timerElement.classList.remove('cheating');
            }
        }

        examTimer.start();
        document.addEventListener('visibilitychange', handleVisibilityChange);


        // --- SYNCHRONIZED TABS SCRIPT ---
        const passageTabs = document.querySelectorAll('#passageTabs .nav-link');
        passageTabs.forEach(tab => {
            tab.addEventListener('click', function (event) {
                const passageTargetId = this.getAttribute('data-bs-target');
                const questionTargetId = passageTargetId.replace('#p', '#q');
                const questionTab = document.querySelector(`#questionTabs [data-bs-target="${questionTargetId}"]`);
                if (questionTab) {
                    new bootstrap.Tab(questionTab).show();
                }
            });
        });

        // --- ADVANCED HIGHLIGHTER SCRIPT ---
        const menu = document.getElementById('highlighter-menu');
        const highlightBtn = document.getElementById('highlight-btn');
        const deleteBtn = document.getElementById('delete-highlight-btn');
        const highlightableAreas = document.querySelectorAll('.passage-section, .questions-section');

        let savedRange;
        let targetMark;

        function onMouseUp(event) {
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                let ancestorMark = null;
                if (!selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const commonAncestor = range.commonAncestorContainer;
                    ancestorMark = commonAncestor.nodeType === Node.ELEMENT_NODE
                        ? commonAncestor.closest('mark.user-highlight')
                        : commonAncestor.parentElement.closest('mark.user-highlight');
                }

                const clickedMark = event.target.closest('mark.user-highlight');

                if (ancestorMark || (clickedMark && selectedText.length === 0)) {
                    targetMark = ancestorMark || clickedMark;
                    highlightBtn.style.display = 'none';
                    deleteBtn.style.display = 'block';
                    const rect = targetMark.getBoundingClientRect();
                    menu.style.left = `${rect.left + window.scrollX}px`;
                    menu.style.top = `${rect.top + window.scrollY - 40}px`;
                    menu.style.display = 'block';
                } else if (selectedText.length > 0) {
                    savedRange = selection.getRangeAt(0);
                    const rect = savedRange.getBoundingClientRect();
                    highlightBtn.style.display = 'block';
                    deleteBtn.style.display = 'none';
                    menu.style.left = `${rect.right + window.scrollX + 5}px`;
                    menu.style.top = `${rect.top + window.scrollY}px`;
                    menu.style.display = 'block';
                } else {
                    menu.style.display = 'none';
                }
            }, 10);
        }

        highlightableAreas.forEach(area => area.addEventListener('mouseup', onMouseUp));

        highlightBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (savedRange) {
                const mark = document.createElement('mark');
                mark.className = 'user-highlight';
                try {
                    savedRange.surroundContents(mark);
                    savedRange = null;
                } catch (err) { console.error("Highlighting failed:", err); }
            }
            menu.style.display = 'none';
            window.getSelection().removeAllRanges();
        });

        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (targetMark) {
                const parent = targetMark.parentNode;
                while (targetMark.firstChild) {
                    parent.insertBefore(targetMark.firstChild, targetMark);
                }
                parent.removeChild(targetMark);
                targetMark = null;
            }
            menu.style.display = 'none';
        });

        window.addEventListener('click', function(e) {
            if (!menu.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
    });
    </script>
</body>
</html>

